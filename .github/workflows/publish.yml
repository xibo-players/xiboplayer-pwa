name: Publish to npm

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  wait-for-sdk:
    name: Wait for SDK packages on npm
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Extract expected SDK version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Wait for @xiboplayer/cache on npm
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Check if SDK has the same version tag (coordinated release)
          # If not, skip — PWA uses ^0.4.0 ranges so any 0.4.x works
          echo "Checking if @xiboplayer/cache@${VERSION} is expected..."
          LATEST=$(npm view "@xiboplayer/cache" version 2>/dev/null || echo "0.0.0")
          if [ "$LATEST" = "$VERSION" ]; then
            echo "Already on npm"
            exit 0
          fi
          echo "Waiting for @xiboplayer/cache@${VERSION} (current: ${LATEST})..."
          for i in $(seq 1 30); do
            if npm view "@xiboplayer/cache@${VERSION}" version 2>/dev/null; then
              echo "Found on npm after ~$((i * 10))s"
              exit 0
            fi
            sleep 10
          done
          echo "SDK ${VERSION} not published after 5 min — proceeding with latest (${LATEST})"

  publish:
    needs: [wait-for-sdk]
    if: always() && (needs.wait-for-sdk.result == 'success' || needs.wait-for-sdk.result == 'skipped')
    uses: xibo-players/.github/.github/workflows/publish-npm.yml@main
    with:
      cache-deps: false
      install-command: 'pnpm install --no-frozen-lockfile && pnpm run build'
    secrets:
      npm-token: ${{ secrets.NPM_TOKEN }}
