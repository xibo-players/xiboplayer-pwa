name: Publish to npm

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  wait-for-sdk:
    name: Wait for SDK packages on npm
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Extract expected SDK version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Wait for @xiboplayer/cache on npm
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Waiting for @xiboplayer/cache@${VERSION} on npm..."
          for i in $(seq 1 60); do
            if npm view "@xiboplayer/cache@${VERSION}" version 2>/dev/null; then
              echo "Found on npm after ~$((i * 10))s"
              exit 0
            fi
            sleep 10
          done
          echo "Timed out waiting for SDK publish (10 min)"
          exit 1

  publish:
    needs: [wait-for-sdk]
    if: always() && (needs.wait-for-sdk.result == 'success' || needs.wait-for-sdk.result == 'skipped')
    uses: xibo-players/.github/.github/workflows/publish-npm.yml@main
    with:
      cache-deps: false
      install-command: 'pnpm install --no-frozen-lockfile && pnpm run build'
    secrets:
      npm-token: ${{ secrets.NPM_TOKEN }}
